
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>piripherals.mpr121 &#8212; piripherals 0.1 documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for piripherals.mpr121</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;a sane and complete interface to the MPR121 touch sensor</span>

<span class="sd">This is thought to be a replacement of the incomplete and undocumented</span>
<span class="sd">Adafruit.MPR121_ library.</span>

<span class="sd">To fully understand this device, please read the datasheet_.</span>

<span class="sd">Wiring the MPR121 to the RaspberryPi</span>
<span class="sd">~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>

<span class="sd">Connect the pins of MPR121 to the RaspberryPi according to the following table.</span>
<span class="sd">In this doc and in the code, all Pi pin numbers are BCM_ pin numbers, physical</span>
<span class="sd">pin numbers are set in round braces (x).</span>

<span class="sd">========= ============</span>
<span class="sd">MPR121    RaspberryPi</span>
<span class="sd">========= ============</span>
<span class="sd">3.3V      3.3V (1)</span>
<span class="sd">GND       GND (6)</span>
<span class="sd">SDA       BCM 2 (3)</span>
<span class="sd">SCL       BCM 3 (5)</span>
<span class="sd">IRQ*      BCM 4 (7)</span>
<span class="sd">========= ============</span>

<span class="sd">Connecting the IRQ line is optional but recommended to avoid unneccessary bus</span>
<span class="sd">traffic and CPU load due to polling. To able to use the IRQ, you need to have</span>
<span class="sd">RPi.GPIO_ installed (``apt-get install python-rpi.gpio`` or ``pip install RPi.GPIO``).</span>
<span class="sd">You may use a different pin, adjust the number accordingly.</span>

<span class="sd">If you want to connect multiple MPR121s to the same bus, you can change their</span>
<span class="sd">address with the address pin. Refer to the datasheet_ on how to do this.</span>

<span class="sd">Enable I2C access</span>
<span class="sd">~~~~~~~~~~~~~~~~~</span>

<span class="sd">The MPR121 uses I2C for communication. On the RaspberryPi running</span>
<span class="sd">Raspbian_ Stretch, you need to enable the I2C bus. To ``/boot/config.txt``</span>
<span class="sd">add the lines::</span>

<span class="sd">    dtparam=i2c_arm=on</span>
<span class="sd">    dtparam=i2c1=on</span>

<span class="sd">and to ``/etc/modules`` add::</span>

<span class="sd">    i2c-dev</span>

<span class="sd">This should enable the ``/dev/i2c-1`` (bus=1) device on boot. Install i2c-tools with::</span>

<span class="sd">    apt-get install i2c-tools</span>

<span class="sd">and list the addresses of connected devices::</span>

<span class="sd">    i2cdetect -y 1</span>


<span class="sd">For MPR121 being able to access the I2C bus, you need to have a Python smbus</span>
<span class="sd">implementation installed. Use ``python-smbus`` from the distro or smbus2_</span>
<span class="sd">(``apt-get install python-smbus`` or ``pip install smbus2``).</span>

<span class="sd">Using MPR121</span>
<span class="sd">~~~~~~~~~~~~</span>

<span class="sd">Attach the MPR121 to the Pi and use it like::</span>

<span class="sd">    from piripherals import MPR121</span>

<span class="sd">    mpr = MPR121(irq=4) # MPR121 should be up and running with 12 channels</span>
<span class="sd">    for i in range(12):</span>
<span class="sd">        mpr.on_touch(i, lambda *x: print(x)) # print status on touch and release</span>

<span class="sd">Use the ``mpr121-dump`` script to examine the MPR121&#39;s response and to tune</span>
<span class="sd">the settings.</span>

<span class="sd">.. _datasheet: https://www.sparkfun.com/datasheets/Components/MPR121.pdf</span>
<span class="sd">.. _BCM: https://pinout.xyz/</span>
<span class="sd">.. _Raspbian: https://www.raspberrypi.org/downloads/raspbian/</span>
<span class="sd">.. _RPi.GPIO: https://pypi.python.org/pypi/RPi.GPIO</span>
<span class="sd">.. _smbus2: https://pypi.python.org/pypi/smbus2</span>
<span class="sd">.. _Adafruit.MPR121: https://github.com/adafruit/Adafruit_Python_MPR121</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># http://python-future.org/compatible_idioms.html</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;MPR121&#39;</span><span class="p">]</span>

<span class="kn">from</span> <span class="nn">functools</span> <span class="k">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="k">import</span> <span class="n">sleep</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="k">import</span> <span class="n">Thread</span><span class="p">,</span> <span class="n">Event</span>

<span class="n">NCH</span> <span class="o">=</span> <span class="mi">13</span>  <span class="c1"># number of channels</span>
<span class="c1"># REGISTERS</span>
<span class="n">ETS</span> <span class="o">=</span> <span class="mh">0x00</span>  <span class="c1"># touch status</span>
<span class="n">OOR</span> <span class="o">=</span> <span class="mh">0x02</span>  <span class="c1"># out of range status</span>
<span class="n">EFD</span> <span class="o">=</span> <span class="mh">0x04</span>  <span class="c1"># electrode filtered data</span>
<span class="n">EBL</span> <span class="o">=</span> <span class="mh">0x1e</span>  <span class="c1"># baseline value</span>
<span class="n">MHD</span> <span class="o">=</span> <span class="mh">0x2b</span>  <span class="c1"># MHD rising</span>
<span class="n">MHDX</span> <span class="o">=</span> <span class="mh">0x36</span>  <span class="c1"># MHD rising proximity</span>
<span class="n">TTH</span> <span class="o">=</span> <span class="mh">0x41</span>  <span class="c1"># touch threshold 0</span>
<span class="n">RTH</span> <span class="o">=</span> <span class="mh">0x42</span>  <span class="c1"># release threshold 0</span>
<span class="n">DEB</span> <span class="o">=</span> <span class="mh">0x5b</span>  <span class="c1"># debounce</span>
<span class="n">AFE1</span> <span class="o">=</span> <span class="mh">0x5c</span>  <span class="c1"># parameters 1</span>
<span class="n">AFE2</span> <span class="o">=</span> <span class="mh">0x5d</span>  <span class="c1"># parameters 2</span>
<span class="n">ECR</span> <span class="o">=</span> <span class="mh">0x5e</span>  <span class="c1"># electrode control register</span>
<span class="n">CDC</span> <span class="o">=</span> <span class="mh">0x5f</span>  <span class="c1"># electrode current</span>
<span class="n">CDT</span> <span class="o">=</span> <span class="mh">0x6c</span>  <span class="c1"># charge time</span>
<span class="n">GPIO_CTL0</span> <span class="o">=</span> <span class="mh">0x73</span>  <span class="c1"># GPIO control 0</span>
<span class="n">GPIO_CTL1</span> <span class="o">=</span> <span class="mh">0x74</span>  <span class="c1"># GPIO control 1</span>
<span class="n">GPIO_DAT</span> <span class="o">=</span> <span class="mh">0x75</span>  <span class="c1"># GPIO data</span>
<span class="n">GPIO_DIR</span> <span class="o">=</span> <span class="mh">0x76</span>  <span class="c1"># GPIO direction</span>
<span class="n">GPIO_EN</span> <span class="o">=</span> <span class="mh">0x77</span>  <span class="c1"># GPIO enable</span>
<span class="n">GPIO_SET</span> <span class="o">=</span> <span class="mh">0x78</span>  <span class="c1"># GPIO set data</span>
<span class="n">GPIO_CLR</span> <span class="o">=</span> <span class="mh">0x79</span>  <span class="c1"># GPIO clear data</span>
<span class="n">GPIO_TOG</span> <span class="o">=</span> <span class="mh">0x7a</span>  <span class="c1"># GPIO toggle data</span>
<span class="n">ACNF_C0</span> <span class="o">=</span> <span class="mh">0x7b</span>  <span class="c1"># auto config control 0</span>
<span class="n">ACNF_C1</span> <span class="o">=</span> <span class="mh">0x7c</span>  <span class="c1"># auto config control 1</span>
<span class="n">ACNF_USL</span> <span class="o">=</span> <span class="mh">0x7d</span>  <span class="c1"># auto config</span>
<span class="n">ACNF_LSL</span> <span class="o">=</span> <span class="mh">0x7e</span>  <span class="c1"># auto config</span>
<span class="n">ACNF_TL</span> <span class="o">=</span> <span class="mh">0x7f</span>  <span class="c1"># auto config target level</span>
<span class="n">SRESET</span> <span class="o">=</span> <span class="mh">0x80</span>  <span class="c1"># soft reset</span>


<span class="k">def</span> <span class="nf">h</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
    <span class="k">return</span> <span class="s1">&#39;0x</span><span class="si">{:02x}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">b</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
    <span class="k">return</span> <span class="s1">&#39;</span><span class="si">{:08b}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">w</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
    <span class="k">return</span> <span class="s1">&#39;</span><span class="si">{:016b}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">not_raising</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Wraps a function and swallows exceptions.</span>

<span class="sd">    Args:</span>
<span class="sd">        func: function to wrap</span>

<span class="sd">    Returns:</span>
<span class="sd">        wrapped function, that does not raise Exceptions,</span>
<span class="sd">        Exceptions are printed to console_scripts</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">traceback</span>

    <span class="k">def</span> <span class="nf">logging_func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">logging_func</span>


<span class="k">class</span> <span class="nc">IRQHandler</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Abstraction of IRQ handler.</span>

<span class="sd">    An edge on the pin sets a flag.  The callback is invoked on a separate</span>
<span class="sd">    thread when the flag was set.  The flag is reset when the pin is high again.</span>
<span class="sd">    The callback may be invoked repeatedly if the pin does not reset.</span>

<span class="sd">    Args:</span>
<span class="sd">        pin (int): BCM# of pin attached to IRQ line.</span>
<span class="sd">        callback: function invoked on IRQ.</span>
<span class="sd">        edge (int): fire interrupt on falling=0 or rising=1 edge.</span>
<span class="sd">        pullup (int): activate internal pullup</span>
<span class="sd">            1=pullup, 0=nothing, -1=pulldown.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">edge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">pullup</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">RPi.GPIO</span> <span class="k">as</span> <span class="nn">GPIO</span>
        <span class="n">GPIO</span><span class="o">.</span><span class="n">setmode</span><span class="p">(</span><span class="n">GPIO</span><span class="o">.</span><span class="n">BCM</span><span class="p">)</span>
        <span class="kn">import</span> <span class="nn">atexit</span>
        <span class="n">atexit</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="n">GPIO</span><span class="o">.</span><span class="n">cleanup</span><span class="p">,</span> <span class="n">pin</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_irq</span> <span class="o">=</span> <span class="n">Event</span><span class="p">()</span>

        <span class="n">pud</span> <span class="o">=</span> <span class="p">[</span><span class="n">GPIO</span><span class="o">.</span><span class="n">PUD_DOWN</span><span class="p">,</span> <span class="n">GPIO</span><span class="o">.</span><span class="n">PUD_OFF</span><span class="p">,</span> <span class="n">GPIO</span><span class="o">.</span><span class="n">PUD_UP</span><span class="p">][</span><span class="n">pullup</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">callback</span> <span class="o">=</span> <span class="n">not_raising</span><span class="p">(</span><span class="n">callback</span><span class="p">)</span>
        <span class="n">reset</span> <span class="o">=</span> <span class="n">GPIO</span><span class="o">.</span><span class="n">LOW</span> <span class="k">if</span> <span class="n">edge</span> <span class="k">else</span> <span class="n">GPIO</span><span class="o">.</span><span class="n">HIGH</span>
        <span class="n">edge</span> <span class="o">=</span> <span class="n">GPIO</span><span class="o">.</span><span class="n">RISING</span> <span class="k">if</span> <span class="n">edge</span> <span class="k">else</span> <span class="n">GPIO</span><span class="o">.</span><span class="n">FALLING</span>

        <span class="n">GPIO</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">pin</span><span class="p">,</span> <span class="n">GPIO</span><span class="o">.</span><span class="n">IN</span><span class="p">,</span> <span class="n">pull_up_down</span><span class="o">=</span><span class="n">pud</span><span class="p">)</span>
        <span class="n">GPIO</span><span class="o">.</span><span class="n">add_event_detect</span><span class="p">(</span><span class="n">pin</span><span class="p">,</span> <span class="n">edge</span><span class="p">,</span> <span class="k">lambda</span> <span class="o">*</span><span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_irq</span><span class="o">.</span><span class="n">set</span><span class="p">())</span>

        <span class="k">def</span> <span class="nf">loop</span><span class="p">():</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_irq</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
                <span class="n">callback</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">GPIO</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="n">pin</span><span class="p">)</span> <span class="o">==</span> <span class="n">reset</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_irq</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">loop</span><span class="p">,</span> <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">Poller</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Polling loop as replacement for IRQHandler.</span>

<span class="sd">    Use it if using the IRQ line is not possible or desired.</span>

<span class="sd">    Args:</span>
<span class="sd">        callcack: function that is called continously. The actuall polling</span>
<span class="sd">            happens in this callback.</span>
<span class="sd">        delay (float): delay in seconds between invocations of callback</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mf">0.01</span><span class="p">):</span>

        <span class="n">callback</span> <span class="o">=</span> <span class="n">not_raising</span><span class="p">(</span><span class="n">callback</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">loop</span><span class="p">():</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">callback</span><span class="p">()</span>
                <span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>

        <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">loop</span><span class="p">,</span> <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>


<span class="n">noop</span> <span class="o">=</span> <span class="k">lambda</span> <span class="o">*</span><span class="n">x</span><span class="p">:</span> <span class="kc">None</span>


<div class="viewcode-block" id="MPR121"><a class="viewcode-back" href="../../piripherals.mpr121.html#piripherals.mpr121.MPR121">[docs]</a><span class="k">class</span> <span class="nc">MPR121</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;MPR121 capacitive touch sensor and GPIO/LED controller.</span>

<span class="sd">    It will be configured with sane defaults and started immediately.</span>

<span class="sd">    Args:</span>
<span class="sd">        addr (int): I2C address of the device</span>
<span class="sd">        bus (int): I2C bus, 1 = /dev/i2c-1</span>
<span class="sd">        irq (int): GPIO BCM pin # that is connect to interrupt line,</span>
<span class="sd">            0=disbale IRQ, use polling</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">addr</span><span class="o">=</span><span class="mh">0x5a</span><span class="p">,</span> <span class="n">bus</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">irq</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">.bus</span> <span class="k">import</span> <span class="n">Bus</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">addr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">overcurrent</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bus</span> <span class="o">=</span> <span class="n">Bus</span><span class="p">(</span><span class="n">bus</span><span class="p">)</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_handlers</span> <span class="o">=</span> <span class="p">[</span><span class="n">noop</span><span class="p">]</span> <span class="o">*</span> <span class="n">NCH</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_touched</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">def</span> <span class="nf">handle_touch</span><span class="p">():</span>
            <span class="n">t0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_touched</span>
            <span class="n">t1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_touched</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">touched</span><span class="p">()</span>
            <span class="n">ch</span> <span class="o">=</span> <span class="n">t0</span> <span class="o">^</span> <span class="n">t1</span>
            <span class="k">if</span> <span class="n">ch</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_touch</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">ch</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">irq</span><span class="p">:</span>
            <span class="n">IRQHandler</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">handle_touch</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Poller</span><span class="p">(</span><span class="n">handle_touch</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_handle_touch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">touched</span><span class="p">,</span> <span class="n">changed</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Invokes touch handlers if touch status changed.</span>

<span class="sd">        Args:</span>
<span class="sd">            touched (int): byte containing touch status bits</span>
<span class="sd">                bit is 1 if channel is touched</span>
<span class="sd">            changed (int): byte containing status change bits</span>
<span class="sd">                bit is 1 if touch status has changed</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NCH</span><span class="p">):</span>
            <span class="n">m</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span>
            <span class="k">if</span> <span class="n">changed</span> <span class="o">&amp;</span> <span class="n">m</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_handlers</span><span class="p">[</span><span class="n">i</span><span class="p">]((</span><span class="n">touched</span> <span class="o">&amp;</span> <span class="n">m</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_handlers</span><span class="p">[</span><span class="n">i</span><span class="p">]((</span><span class="n">touched</span> <span class="o">&amp;</span> <span class="n">m</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>

<div class="viewcode-block" id="MPR121.is_touched"><a class="viewcode-back" href="../../piripherals.mpr121.html#piripherals.mpr121.MPR121.is_touched">[docs]</a>    <span class="k">def</span> <span class="nf">is_touched</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get touch status.</span>

<span class="sd">        Args:</span>
<span class="sd">            channel (int): channel to get status for, 0-12</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if touched</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_touched</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">channel</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="MPR121.on_touch"><a class="viewcode-back" href="../../piripherals.mpr121.html#piripherals.mpr121.MPR121.on_touch">[docs]</a>    <span class="k">def</span> <span class="nf">on_touch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">handler</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Register touch handler, invoked on state change.</span>

<span class="sd">        Args:</span>
<span class="sd">            channel (int): channel to attach the handler to (0-12, 12=proximity)</span>
<span class="sd">            handler (callable(boolean, [channel])): handler,</span>
<span class="sd">                it gets passed a channel number [optional] and a boolean (True=touched),</span>
<span class="sd">                Pass None to remove any assigned handler.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_handlers</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span> <span class="o">=</span> <span class="n">not_raising</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span> <span class="ow">or</span> <span class="n">noop</span></div>

<div class="viewcode-block" id="MPR121.reset"><a class="viewcode-back" href="../../piripherals.mpr121.html#piripherals.mpr121.MPR121.reset">[docs]</a>    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Perform soft reset.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bus</span><span class="o">.</span><span class="n">write_byte</span><span class="p">(</span><span class="n">SRESET</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">)</span></div>

<div class="viewcode-block" id="MPR121.configure"><a class="viewcode-back" href="../../piripherals.mpr121.html#piripherals.mpr121.MPR121.configure">[docs]</a>    <span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cl</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">prox</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">touch</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;activate/deactivate measurement.</span>

<span class="sd">        Deactivate measurement with prox=0 and touch=0.</span>

<span class="sd">        Args:</span>
<span class="sd">            cl (int): calibration lock:</span>
<span class="sd">                0 = baseline tracking enabled,</span>
<span class="sd">                1 = baseline tracking disbled,</span>
<span class="sd">                2 = baseline tracking enabled, init 5MSBs with initial measurement,</span>
<span class="sd">                3 = baseline tracking enabled, init with initial measurement.</span>
<span class="sd">            prox (int): proximity detection:</span>
<span class="sd">                0 = disabled,</span>
<span class="sd">                1 = enabled on electrodes 0-1,</span>
<span class="sd">                2 = enabled on electrodes 0-3,</span>
<span class="sd">                3 = enabled on electrodes 0-11.</span>
<span class="sd">            touch (int): enable electrodes:</span>
<span class="sd">                0 = disabled,</span>
<span class="sd">                1 = enable electrode 0,</span>
<span class="sd">                2 = enable electrodes 0-1,</span>
<span class="sd">                3 = enable electrodes 0-2,</span>
<span class="sd">                ...,</span>
<span class="sd">                12 = enable electrodes 0-11.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bus</span><span class="o">.</span><span class="n">write_byte</span><span class="p">(</span><span class="n">ECR</span><span class="p">,</span> <span class="p">(</span><span class="n">cl</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">prox</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">touch</span><span class="p">)</span></div>

<div class="viewcode-block" id="MPR121.touched"><a class="viewcode-back" href="../../piripherals.mpr121.html#piripherals.mpr121.MPR121.touched">[docs]</a>    <span class="k">def</span> <span class="nf">touched</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get touch status bits to the device.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: first 12 bits contain touch status, 1=touched</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception: on overcurrent</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">word</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bus</span><span class="o">.</span><span class="n">read_word</span><span class="p">(</span><span class="n">ETS</span><span class="p">)</span>
        <span class="n">overcurrent</span> <span class="o">=</span> <span class="p">(</span><span class="n">word</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">overcurrent</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;overcurrent&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out_of_range</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">word</span> <span class="o">&amp;</span> <span class="mh">0x0fff</span></div>

<div class="viewcode-block" id="MPR121.electrode_data"><a class="viewcode-back" href="../../piripherals.mpr121.html#piripherals.mpr121.MPR121.electrode_data">[docs]</a>    <span class="k">def</span> <span class="nf">electrode_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get raw eletrode measurement data.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list of int: raw 10 bit eletrode measurement per eletrode</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">bytes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bus</span><span class="o">.</span><span class="n">read_block</span><span class="p">(</span><span class="n">EFD</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">NCH</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NCH</span><span class="p">):</span>
            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="nb">bytes</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="nb">bytes</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">data</span></div>

<div class="viewcode-block" id="MPR121.baseline"><a class="viewcode-back" href="../../piripherals.mpr121.html#piripherals.mpr121.MPR121.baseline">[docs]</a>    <span class="k">def</span> <span class="nf">baseline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rft</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">mhd</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nhd</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ncl</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">fdl</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">prox</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get raw baslines or configure baseline tracking.</span>

<span class="sd">        Args:</span>
<span class="sd">            rft (int): scenario to set the values for:</span>
<span class="sd">                0 = rising, raw eletrode data &gt; current baseline,</span>
<span class="sd">                1 = falling, raw eletrode data &lt; current baseline,</span>
<span class="sd">                2 = touched, eletrode in touch status.</span>
<span class="sd">            mhd (int): max. half delta 0-63 (for rft=0 or 1 only),</span>
<span class="sd">                largest magnitude of variation to pass through the baseline filter.</span>
<span class="sd">            nhd (int): noise half delta 0-63,</span>
<span class="sd">                incremental change when non-noise drift is detected.</span>
<span class="sd">            ncl (int): noise count limit 0-255,</span>
<span class="sd">                number of samples consecutively greater than mhd necessary</span>
<span class="sd">                before if can be determined that it is non-noise.</span>
<span class="sd">            fdl (int): filter delay count limit 0-255,</span>
<span class="sd">                rate of operation of the filer, greater values makes it operate slower.</span>
<span class="sd">            prox (bool): if True set values for proximity mode.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list of ints: raw 10 bit baseline values per eletrode, if invoked with no args.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">rft</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">b</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bus</span><span class="o">.</span><span class="n">read_block</span><span class="p">(</span><span class="n">EBL</span><span class="p">,</span> <span class="n">NCH</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">MHDX</span> <span class="k">if</span> <span class="n">prox</span> <span class="k">else</span> <span class="n">MHD</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">rft</span>
            <span class="k">if</span> <span class="n">rft</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bus</span><span class="o">.</span><span class="n">write_block</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="p">[</span><span class="n">nhd</span><span class="p">,</span> <span class="n">ncl</span><span class="p">,</span> <span class="n">fdl</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bus</span><span class="o">.</span><span class="n">write_block</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="p">[</span><span class="n">mhd</span><span class="p">,</span> <span class="n">nhd</span><span class="p">,</span> <span class="n">ncl</span><span class="p">,</span> <span class="n">fdl</span><span class="p">])</span></div>

<div class="viewcode-block" id="MPR121.threshold"><a class="viewcode-back" href="../../piripherals.mpr121.html#piripherals.mpr121.MPR121.threshold">[docs]</a>    <span class="k">def</span> <span class="nf">threshold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">touch</span><span class="p">,</span> <span class="n">release</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">channel</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set touch and release thresholds.</span>

<span class="sd">        Usually touch &gt; release for hysteresis.</span>

<span class="sd">        Args:</span>
<span class="sd">            touch (int): touch threshold 0-255</span>
<span class="sd">            release (int): release threshold 0-255</span>
<span class="sd">                if ommited release=0.6*touch</span>
<span class="sd">            channel (int): channel to set thresholds for 0-12 (12=proximity)</span>
<span class="sd">                if ommited apply thresholds to all channels</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">release</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">release</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.6</span> <span class="o">*</span> <span class="n">touch</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">channel</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NCH</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">(</span><span class="n">touch</span><span class="p">,</span> <span class="n">release</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_bus</span><span class="o">.</span><span class="n">write_byte</span><span class="p">(</span><span class="n">TTH</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">channel</span><span class="p">,</span> <span class="n">touch</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_bus</span><span class="o">.</span><span class="n">write_byte</span><span class="p">(</span><span class="n">RTH</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">channel</span><span class="p">,</span> <span class="n">release</span><span class="p">)</span></div>

<div class="viewcode-block" id="MPR121.debounce"><a class="viewcode-back" href="../../piripherals.mpr121.html#piripherals.mpr121.MPR121.debounce">[docs]</a>    <span class="k">def</span> <span class="nf">debounce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">touch</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">release</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Configure debouncing.</span>

<span class="sd">        # of consecutiv measurements with same result needed to trigger state change.</span>

<span class="sd">        Args:</span>
<span class="sd">            touch (int): for touch 0-7</span>
<span class="sd">            release (int): for release 0-7, if ommited release=touch</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">release</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">release</span> <span class="o">=</span> <span class="n">touch</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bus</span><span class="o">.</span><span class="n">write_byte</span><span class="p">(</span><span class="n">DEB</span><span class="p">,</span> <span class="p">(</span><span class="n">release</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">touch</span><span class="p">)</span></div>

<div class="viewcode-block" id="MPR121.filter"><a class="viewcode-back" href="../../piripherals.mpr121.html#piripherals.mpr121.MPR121.filter">[docs]</a>    <span class="k">def</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cdc</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">cdt</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ffi</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sfi</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">esi</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Settings for global eletrode charging, sampling and filtering.</span>

<span class="sd">        Effective measurement cycle period is sfi*esi.</span>

<span class="sd">        Args:</span>
<span class="sd">            cdc (int): charge-discharge-current 0-63 (uA)</span>
<span class="sd">            cdt (int): charge-discharge-time 0-7 (0.5*2**(cdt-1) us)</span>
<span class="sd">            ffi (int): first filter iterations 0-3 (6,10,18,34)</span>
<span class="sd">            sfi (int): second filter iterations 0-3 (4,6,10,18)</span>
<span class="sd">            esi (int): eletrode sample interval 0-7 (2**esi ms)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lb</span> <span class="o">=</span> <span class="p">(</span><span class="n">ffi</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="n">cdc</span>
        <span class="n">hb</span> <span class="o">=</span> <span class="p">(</span><span class="n">cdt</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">sfi</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="n">esi</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bus</span><span class="o">.</span><span class="n">write_word</span><span class="p">(</span><span class="n">AFE1</span><span class="p">,</span> <span class="p">(</span><span class="n">hb</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">lb</span><span class="p">)</span></div>

<div class="viewcode-block" id="MPR121.charge"><a class="viewcode-back" href="../../piripherals.mpr121.html#piripherals.mpr121.MPR121.charge">[docs]</a>    <span class="k">def</span> <span class="nf">charge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">current</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Configure change current and time per channel.</span>

<span class="sd">        These values are determined automatically when auto_config is activated.</span>

<span class="sd">        Args:</span>
<span class="sd">            channel (int): channel to configure 0-11</span>
<span class="sd">            current (int): charge current</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bus</span><span class="o">.</span><span class="n">write_byte</span><span class="p">(</span><span class="n">CDC</span> <span class="o">+</span> <span class="n">channel</span><span class="p">,</span> <span class="n">current</span><span class="p">)</span>
        <span class="n">reg</span> <span class="o">=</span> <span class="n">CDT</span> <span class="o">+</span> <span class="n">channel</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">s</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="n">channel</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bus</span><span class="o">.</span><span class="n">write_byte</span><span class="p">(</span>
            <span class="n">reg</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bus</span><span class="o">.</span><span class="n">read_byte</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mh">0xf</span> <span class="o">&lt;&lt;</span> <span class="n">s</span><span class="p">))</span> <span class="o">|</span> <span class="p">(</span><span class="n">time</span> <span class="o">&lt;&lt;</span> <span class="n">s</span><span class="p">))</span></div>

<div class="viewcode-block" id="MPR121.auto_config"><a class="viewcode-back" href="../../piripherals.mpr121.html#piripherals.mpr121.MPR121.auto_config">[docs]</a>    <span class="k">def</span> <span class="nf">auto_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                    <span class="n">ace</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">are</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">bva</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                    <span class="n">retry</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                    <span class="n">afes</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">scts</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                    <span class="n">acfie</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">arfie</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">oorie</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">usl</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
                    <span class="n">lsl</span><span class="o">=</span><span class="mi">130</span><span class="p">,</span>
                    <span class="n">tl</span><span class="o">=</span><span class="mi">180</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Configure automatic adjustment eletrode change current and time.</span>

<span class="sd">        Args:</span>
<span class="sd">            ace (bool): enable auto configuration</span>
<span class="sd">            are (bool): enable auto reconfiguration</span>
<span class="sd">            bva (int): baseline adjustment after current and time have been set:</span>
<span class="sd">                0 = no change,</span>
<span class="sd">                1 = set to zero,</span>
<span class="sd">                2 = set 5MSBs to measured value,</span>
<span class="sd">                3 = set to measured value.</span>
<span class="sd">            retry (int): # of retries for auto configuration: 0-3 (0,2,4,8)</span>
<span class="sd">            afes (int): # of AFE sample during search process, set to values</span>
<span class="sd">                as filter(ffi): 0-3 (6,10,18,34)</span>
<span class="sd">            scts (bool): skip charge time search</span>
<span class="sd">            acfie (bool): enable IRQ on auto config failure</span>
<span class="sd">            arfie (bool): enable IRQ on auto reconfig failure</span>
<span class="sd">            oorie (bool): enable IRQ on out of range event</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lb</span> <span class="o">=</span> <span class="p">(</span><span class="n">afes</span> <span class="o">&amp;</span> <span class="mb">0b11</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">retry</span> <span class="o">&amp;</span> <span class="mb">0b11</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">bva</span> <span class="o">&amp;</span> <span class="mb">0b11</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span>
            <span class="n">are</span> <span class="o">&amp;</span> <span class="mb">0b1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">ace</span> <span class="o">&amp;</span> <span class="mb">0b1</span>
        <span class="n">hb</span> <span class="o">=</span> <span class="p">(</span><span class="n">scts</span> <span class="o">&amp;</span> <span class="mb">0b1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">oorie</span> <span class="o">&amp;</span> <span class="mb">0b1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span>
            <span class="n">arfie</span> <span class="o">&amp;</span> <span class="mb">0b1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">acfie</span> <span class="o">&amp;</span> <span class="mb">0b1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bus</span><span class="o">.</span><span class="n">write_word</span><span class="p">(</span><span class="n">ACNF_C0</span><span class="p">,</span> <span class="p">(</span><span class="n">hb</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">lb</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bus</span><span class="o">.</span><span class="n">write_byte</span><span class="p">(</span><span class="n">ACNF_USL</span><span class="p">,</span> <span class="n">usl</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bus</span><span class="o">.</span><span class="n">write_byte</span><span class="p">(</span><span class="n">ACNF_LSL</span><span class="p">,</span> <span class="n">lsl</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bus</span><span class="o">.</span><span class="n">write_byte</span><span class="p">(</span><span class="n">ACNF_TL</span><span class="p">,</span> <span class="n">tl</span><span class="p">)</span></div>

<div class="viewcode-block" id="MPR121.out_of_range"><a class="viewcode-back" href="../../piripherals.mpr121.html#piripherals.mpr121.MPR121.out_of_range">[docs]</a>    <span class="k">def</span> <span class="nf">out_of_range</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;get out of range status.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: first 12 bits contain oor status.</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception: if auto (re)config has failed</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">word</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bus</span><span class="o">.</span><span class="n">read_word</span><span class="p">(</span><span class="n">OOR</span><span class="p">)</span>
        <span class="n">auto_config_failed</span> <span class="o">=</span> <span class="p">(</span><span class="n">word</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">auto_config_failed</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;auto config failed&#39;</span><span class="p">)</span>
        <span class="n">auto_reconfig_failed</span> <span class="o">=</span> <span class="p">(</span><span class="n">word</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">auto_reconfig_failed</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;auto reconfig failed&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">word</span> <span class="o">&amp;</span> <span class="mh">0x0fff</span></div>

<div class="viewcode-block" id="MPR121.gpio_setup"><a class="viewcode-back" href="../../piripherals.mpr121.html#piripherals.mpr121.MPR121.gpio_setup">[docs]</a>    <span class="k">def</span> <span class="nf">gpio_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">enable</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Setup GPIO configuration.</span>

<span class="sd">        Args:</span>
<span class="sd">            channel (int): channel to configure (4-11)</span>
<span class="sd">            output (bool): configure as 1=output or 0=input</span>
<span class="sd">            mode (int): pin mode, when output:</span>
<span class="sd">                0 = CMOS output,</span>
<span class="sd">                2 = open drain output, low side MOS only,</span>
<span class="sd">                3 = open drain output, high side MOS only,</span>
<span class="sd">                when input:</span>
<span class="sd">                0 = input,</span>
<span class="sd">                2 = input with pull-down,</span>
<span class="sd">                3 = input with pull-up.</span>
<span class="sd">            enable (bool): enable/disbale GPIO functionality</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="mi">4</span> <span class="o">&lt;=</span> <span class="n">channel</span> <span class="o">&lt;=</span> <span class="mi">11</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="n">mode</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">channel</span> <span class="o">-=</span> <span class="mi">4</span>

        <span class="k">def</span> <span class="nf">set_bit</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">bit</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;0x</span><span class="si">{:02x}</span><span class="s1">=</span><span class="si">{:08b}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_bus</span><span class="o">.</span><span class="n">read_byte</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">))</span> <span class="o">|</span>
                                           <span class="p">((</span><span class="mi">1</span> <span class="k">if</span> <span class="n">value</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_bus</span><span class="o">.</span><span class="n">write_byte</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span>
                                 <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bus</span><span class="o">.</span><span class="n">read_byte</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">))</span> <span class="o">|</span>
                                 <span class="p">((</span><span class="mi">1</span> <span class="k">if</span> <span class="n">value</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">))</span>

        <span class="n">set_bit</span><span class="p">(</span><span class="n">GPIO_CTL0</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">mode</span> <span class="o">&amp;</span> <span class="mb">0b10</span><span class="p">)</span>
        <span class="n">set_bit</span><span class="p">(</span><span class="n">GPIO_CTL1</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">mode</span> <span class="o">&amp;</span> <span class="mb">0b01</span><span class="p">)</span>
        <span class="n">set_bit</span><span class="p">(</span><span class="n">GPIO_DIR</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">output</span> <span class="o">&amp;</span> <span class="mb">0b1</span><span class="p">)</span>
        <span class="n">set_bit</span><span class="p">(</span><span class="n">GPIO_EN</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">enable</span> <span class="o">&amp;</span> <span class="mb">0b1</span><span class="p">)</span></div>

<div class="viewcode-block" id="MPR121.gpio_status"><a class="viewcode-back" href="../../piripherals.mpr121.html#piripherals.mpr121.MPR121.gpio_status">[docs]</a>    <span class="k">def</span> <span class="nf">gpio_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get GPIO status bits.</span>

<span class="sd">        Returns:</span>
<span class="sd">            GPIO status byte for channels 4-11</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bus</span><span class="o">.</span><span class="n">read_byte</span><span class="p">(</span><span class="n">GPIO_DAT</span><span class="p">)</span></div>

<div class="viewcode-block" id="MPR121.gpio_set"><a class="viewcode-back" href="../../piripherals.mpr121.html#piripherals.mpr121.MPR121.gpio_set">[docs]</a>    <span class="k">def</span> <span class="nf">gpio_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set GPIO channel.</span>

<span class="sd">        Args:</span>
<span class="sd">            channel (int): channel to set 4-11</span>
<span class="sd">            value (bool): set 1=HIGH or 0=LOW</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="mi">4</span> <span class="o">&lt;=</span> <span class="n">channel</span> <span class="o">&lt;=</span> <span class="mi">11</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bus</span><span class="o">.</span><span class="n">write_byte</span><span class="p">(</span><span class="n">GPIO_SET</span>
                             <span class="k">if</span> <span class="n">value</span> <span class="k">else</span> <span class="n">GPIO_CLR</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">channel</span> <span class="o">-</span> <span class="mi">4</span><span class="p">))</span></div>

<div class="viewcode-block" id="MPR121.dump"><a class="viewcode-back" href="../../piripherals.mpr121.html#piripherals.mpr121.MPR121.dump">[docs]</a>    <span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">regs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">up</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">loop</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dump raw values, baseline and touch status to console.</span>

<span class="sd">        Uses this repeatedly to adjust the configuration.</span>

<span class="sd">        Args:</span>
<span class="sd">            regs (bool): dump register values</span>
<span class="sd">            up (bool): move cursor up after dump</span>
<span class="sd">            loop (int): run in loop for given # of rounds</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">sys</span>

        <span class="n">tth</span><span class="p">,</span> <span class="n">rth</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NCH</span><span class="p">):</span>
            <span class="n">tth</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bus</span><span class="o">.</span><span class="n">read_byte</span><span class="p">(</span><span class="n">TTH</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">))</span>
            <span class="n">rth</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bus</span><span class="o">.</span><span class="n">read_byte</span><span class="p">(</span><span class="n">RTH</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">loop</span><span class="p">):</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="mi">4</span>
            <span class="n">fs</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">0x</span><span class="si">{:02x}</span><span class="s1"> = 0x</span><span class="si">{:02x}</span><span class="s1"> b</span><span class="si">{:08b}</span><span class="s1"> </span><span class="si">{:3d}</span><span class="se">\033</span><span class="s1">[0m    &#39;</span> <span class="o">*</span> <span class="n">cols</span>
            <span class="k">if</span> <span class="n">regs</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cols</span><span class="p">):</span>
                    <span class="n">data</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bus</span><span class="o">.</span><span class="n">read_block</span><span class="p">(</span><span class="mi">32</span> <span class="o">*</span> <span class="n">i</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">32</span><span class="p">):</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cols</span><span class="p">):</span>
                        <span class="n">k</span> <span class="o">=</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">32</span> <span class="o">*</span> <span class="n">i</span>
                        <span class="n">c</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[33m&#39;</span> <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
                        <span class="n">x</span> <span class="o">+=</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">fs</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="p">))</span>

            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; E:  raw base diff (touched) [GPIO]&#39;</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="mi">73</span> <span class="o">+</span>
                  <span class="s1">&#39;  cdc     cdt oor&#39;</span><span class="p">)</span>
            <span class="n">n</span> <span class="o">=</span> <span class="mi">80</span>
            <span class="n">ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">touched</span><span class="p">()</span>
            <span class="n">gp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gpio_status</span><span class="p">()</span>
            <span class="n">ed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">electrode_data</span><span class="p">()</span>
            <span class="n">bl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseline</span><span class="p">()</span>
            <span class="n">oo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_of_range</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NCH</span><span class="p">):</span>
                <span class="n">e</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="n">ed</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="mh">0x3ff</span><span class="p">)</span>
                <span class="n">b</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="n">bl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="mh">0x3ff</span><span class="p">)</span>
                <span class="n">bar</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;=&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">e</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;-&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="n">e</span><span class="p">)</span>
                <span class="n">bar</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[0m|</span><span class="se">\033</span><span class="s1">[34m&#39;</span>
                <span class="n">nt</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">b</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="n">tth</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="mi">255</span><span class="p">))</span>
                <span class="n">nr</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">b</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="n">rth</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="mi">255</span><span class="p">))</span>
                <span class="n">bar</span><span class="p">[</span><span class="n">nt</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[33m&#39;</span> <span class="o">+</span> <span class="n">bar</span><span class="p">[</span><span class="n">nt</span><span class="p">]</span>
                <span class="n">bar</span><span class="p">[</span><span class="n">nr</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[32m&#39;</span> <span class="o">+</span> <span class="n">bar</span><span class="p">[</span><span class="n">nr</span><span class="p">]</span>
                <span class="n">t</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="n">ts</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span> <span class="k">else</span> <span class="s1">&#39;0&#39;</span>
                <span class="n">g</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="ow">or</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">11</span> <span class="k">else</span> <span class="s1">&#39;1&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="n">gp</span> <span class="o">&amp;</span>
                                                        <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span>
                                                         <span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)))</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;0&#39;</span>
                <span class="n">cdc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bus</span><span class="o">.</span><span class="n">read_byte</span><span class="p">(</span><span class="n">CDC</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span>
                <span class="n">s</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">cdt</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bus</span><span class="o">.</span><span class="n">read_byte</span><span class="p">(</span><span class="n">CDT</span> <span class="o">+</span> <span class="n">i</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">s</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span>
                <span class="n">o</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="n">oo</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span> <span class="k">else</span> <span class="s1">&#39;0&#39;</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s1">&#39;</span><span class="si">{:2d}</span><span class="s1">: </span><span class="si">{:4d}</span><span class="s1"> </span><span class="si">{:4d}</span><span class="s1"> </span><span class="si">{:4d}</span><span class="s1"> (</span><span class="si">{}</span><span class="s1">) [</span><span class="si">{}</span><span class="s1">] </span><span class="se">\033</span><span class="s1">[31m</span><span class="si">{}</span><span class="se">\033</span><span class="s1">[0m </span><span class="si">{:3d}</span><span class="s1">uA </span><span class="si">{:5.1f}</span><span class="s1">us  </span><span class="si">{}</span><span class="s1">   &#39;</span><span class="o">.</span>
                    <span class="nb">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ed</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">bl</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ed</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">bl</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">t</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">bar</span><span class="p">),</span>
                           <span class="n">cdc</span><span class="p">,</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="n">cdt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">o</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">up</span><span class="p">:</span>  <span class="c1"># move cursor up</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[F&#39;</span> <span class="o">*</span> <span class="p">((</span><span class="n">regs</span> <span class="o">*</span> <span class="mi">32</span><span class="p">)</span> <span class="o">+</span> <span class="n">NCH</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span></div>

<div class="viewcode-block" id="MPR121.setup"><a class="viewcode-back" href="../../piripherals.mpr121.html#piripherals.mpr121.MPR121.setup">[docs]</a>    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reset</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">channels</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">prox</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">debounce</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Configure the device with sane defaults.</span>

<span class="sd">        Args:</span>
<span class="sd">            reset (bool): perform soft reset</span>
<span class="sd">            channels (int): number of channels to activate 0-12</span>
<span class="sd">            threshold (int): touch threshold 0-255</span>
<span class="sd">            debounce (int): debounce count 0-7</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">reset</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">configure</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">cdc</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">cdt</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ffi</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sfi</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">esi</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auto_config</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">(</span><span class="n">touch</span><span class="o">=</span><span class="n">threshold</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">(</span><span class="n">channel</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">touch</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debounce</span><span class="p">(</span><span class="n">debounce</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">baseline</span><span class="p">(</span><span class="n">rft</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">mhd</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">nhd</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncl</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">fdl</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">baseline</span><span class="p">(</span><span class="n">rft</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">mhd</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">nhd</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncl</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">fdl</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">prox</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">touch</span><span class="o">=</span><span class="n">channels</span><span class="p">,</span> <span class="n">prox</span><span class="o">=</span><span class="n">prox</span><span class="p">)</span></div></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span> <span class="n">main</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">MPR121</span><span class="p">()</span>
    <span class="n">m</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1000000</span><span class="p">)</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../../index.html">
    <img class="logo" src="../../_static/logo.png" alt="Logo"/>
    
    <h1 class="logo logo-name">piripherals</h1>
    
  </a>
</p>



<p class="blurb">peripherals for the pi</p>




<p>
<iframe src="https://ghbtns.com/github-btn.html?user=quantenschaum&repo=piripherals&type=watch&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../piripherals.html">piripherals package</a></li>
</ul>


<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, quantenschaum.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.6.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
    </div>

    

    
    <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-107589767-1']);
      _gaq.push(['_setDomainName', 'none']);
      _gaq.push(['_setAllowLinker', true]);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>
    
  </body>
</html>